dist: trusty
sudo: required

# python, for proviola
language: python

python:
 - "2.7"

addons:
  apt:
    sources:
    - avsm
# new version of graphviz (>= 2.38) to work around trouble in init_rank
    - sourceline: 'ppa:jgross-h/graphviz'
    - sourceline: 'ppa:jgross-h/coq-master-daily'
    packages:
    - aspcud
# This should be conditional on the matrix
    - ghc
    - cabal-install
    - libgraphviz4
    - graphviz
    - xsltproc
    - python-lxml
    - python-pexpect
    - libxml2-dev
    - libxslt1-dev
    - time
    - ocaml
    - camlp5
    - camlp4
    - ocaml-findlib
    - libocamlgraph-ocaml-dev
    - lua5.1

cache:
  apt: true

# don't build the autogenerated master-with-autoreconf-files
branches:
 except:
   - master-with-autoreconf-files

env:

 matrix:
   - WITH_AUTORECONF=""    UPDATE_HTML="" UPDATE_QUICK_DOC="" UPDATE_AUTOGEN="" UPDATE_DEP_GRAPHS="" BUILD_COQ="" UPDATE_OPAM="" FORCE_COQ_VERSION="" VALIDATE=""
   - WITH_AUTORECONF="yes" UPDATE_HTML="" UPDATE_QUICK_DOC="" UPDATE_AUTOGEN="" UPDATE_DEP_GRAPHS="" BUILD_COQ="" UPDATE_OPAM="" FORCE_COQ_VERSION="" VALIDATE=""
   - UPDATE_DEP_GRAPHS="yes" WITH_AUTORECONF="yes"
   - UPDATE_QUICK_DOC="yes"  WITH_AUTORECONF="yes" UPDATE_AUTOGEN="yes" UPDATE_OPAM="yes"
   - UPDATE_HTML="yes"       WITH_AUTORECONF="yes"
   - VALIDATE="yes"
   - FORCE_COQ_VERSION=""       BUILD_COQ="yes" WITH_AUTORECONF="yes"
   - FORCE_COQ_VERSION="master" BUILD_COQ="yes" WITH_AUTORECONF="yes"

 global:
# encrypted version of deploy key for pushing
    - secure: "Cm2e4Tvpm+sPTGXZV1ztSA81+PXjYCKOm0rqsfPVZprHSpucP6wbn+6HYJxbrbsI6UIE90/MhEpYScQLVR4OfpOKEQCTdWFMBi0uwhYRygeizdApY4pn/yHR6+pqSm7g5ZF5qOFVUDi48gimVeCgs7hoEEb1Ka8ucaI7Oo0q0f8="

before_script:
 - uname -a
 - ./etc/ci/before_script.sh
 - source ./etc/ci/travis_keep_alive.sh
 - export COMMITISH="$(git rev-list HEAD -1)"


# we must run make at the end, because the success of
# `make-pretty-timed` is not an indication that the build succeeded.
# We also use `make strict-test` at the beginning so that we error
# quickly if someone commited .v files but neglected to mention them.
script: "./autogen.sh && ./configure && if [ -z \"$UPDATE_QUICK_DOC\" ]; then make strict-test && ./etc/coq-scripts/timing/make-pretty-timed.sh V=1 -j2 && make && ./etc/ci/test-install-target.sh && cat ./time-of-build-pretty.log && echo; fi && ./etc/ci/after_success.sh"


after_success:
 - kill $PID_KEEP_ALIVE
