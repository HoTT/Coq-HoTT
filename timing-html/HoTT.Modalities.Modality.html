<html>
<head>
<title>Modality.v</title>
<style>
.time {
  background-color: #ffaaaa;
  height: 100%;
  z-index: -1;
  position: absolute;
}
.code {
  z-index: 0;
  position: relative;
  border-style: solid;
  border-color: transparent;
  border-width: 1px;
}
.code:hover {
  border-style: solid;
  border-color: black;
  border-width: 1px;
}
pre {
  margin: 1px;
}
</style>
</head>
<body>
<h1>Timings for Modality.v</h1>

<div class="code" title="File: Modality.v
Line: 1
Time: 0.038s">
<div class="time" style="width: 100%"></div>
<pre>Require Import HoTT.Basics HoTT.Types.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 1
Time: 0.027s">
<div class="time" style="width: 71.052631578947%"></div>
<pre>
Require Import HFiber Extensions Factorization Limits.Pullback.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 2
Time: 0.003s">
<div class="time" style="width: 7.8947368421053%"></div>
<pre>
Require Export ReflectiveSubuniverse.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 3
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> (* [Export] because many of the lemmas and facts about reflective subuniverses are equally important for modalities. *)

</pre>
</div>
<div class="code" title="File: Modality.v
Line: 4
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>Local Open Scope path_scope.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 4
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

(** * Modalities *)

(** ** Dependent eliminators *)

(** A dependent version of the reflection universal property.  For later use we generalize it to refer to different subuniverses in the reflection and the elimination target. *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 10
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>Class ReflectsD@{i} (O' O : Subuniverse@{i}) (T : Type@{i})
      `{PreReflects@{i} O' T} :=
{
  extendable_to_OO :
    forall (Q : O_reflector O' T -&gt; Type@{i}) {Q_inO : forall x, In O (Q x)},
      ooExtendableAlong (to O' T) Q
}.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 16
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>  

(** In particular, from this we get a dependent eliminator. *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 18
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>Definition OO_ind {O' : Subuniverse} (O : Subuniverse)
           {A : Type} `{ReflectsD O' O A}
           (B : O_reflector O' A -&gt; Type) {B_inO : forall oa, In O (B oa)}
           (f : forall a, B (to O' A a)) (oa : O_reflector O' A)
  : B oa
  := (fst (extendable_to_OO B 1%nat) f).1 oa.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 23
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>

Definition OO_ind_beta {O' O : Subuniverse} {A : Type} `{ReflectsD O' O A}
           (B : O_reflector O' A -&gt; Type) {B_inO : forall oa, In O (B oa)}
           (f : forall a, B (to O' A a)) (a : A)
  : OO_ind O B f (to O' A a) = f a
  := (fst (extendable_to_OO B 1%nat) f).2 a.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 29
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

(** Conversely, if [O] is closed under path-types, a dependent eliminator suffices to prove the whole dependent universal property. *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 31
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>Definition reflectsD_from_OO_ind@{i} {O' O : Subuniverse@{i}}
           {A : Type@{i}} `{PreReflects O' A}
           (OO_ind' : forall (B : O_reflector O' A -&gt; Type@{i})
                             (B_inO : forall oa, In O (B oa))
                             (f : forall a, B (to O' A a))
                             oa, B oa)
           (OO_ind_beta' : forall (B : O_reflector O' A -&gt; Type@{i})
                             (B_inO : forall oa, In O (B oa))
                             (f : forall a, B (to O' A a))
                             a, OO_ind' B B_inO f (to O' A a) = f a)
           (inO_paths' : forall (B : Type@{i}) (B_inO : In O B)
                      (z z' : B), In O (z = z'))
  : ReflectsD O' O A.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 43
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 44
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  constructor.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 45
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  intros Q Q_inO n.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 46
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  revert Q Q_inO.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 47
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> simple_induction n n IHn; intros Q Q_inO.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 47
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  1:exact tt.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 48
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  split.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 49
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 50
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> intros g.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 50
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    exists (OO_ind' Q _ g).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 51
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    rapply OO_ind_beta'.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 52
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 53
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> intros h k.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 53
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    rapply IHn.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 54
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Defined.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 55
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

(** In particular, this is the case if [O] is a reflective subuniverse. *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 57
Time: 0.005s">
<div class="time" style="width: 13.157894736842%"></div>
<pre>Definition reflectsD_from_RSU {O' : Subuniverse} {O : ReflectiveSubuniverse}
           {A : Type} `{PreReflects O' A}
           (OO_ind' : forall (B : O_reflector O' A -&gt; Type)
                             (B_inO : forall oa, In O (B oa))
                             (f : forall a, B (to O' A a))
                             oa, B oa)
           (OO_ind_beta' : forall (B : O_reflector O' A -&gt; Type)
                             (B_inO : forall oa, In O (B oa))
                             (f : forall a, B (to O' A a))
                             a, OO_ind' B B_inO f (to O' A a) = f a)
  : ReflectsD O' O A
  := reflectsD_from_OO_ind OO_ind' OO_ind_beta' _.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 68
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

(** Of course, with funext this becomes an actual equivalence. *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 70
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>Definition isequiv_oD_to_O
           {fs : Funext} (O' O : Subuniverse) {A : Type} `{ReflectsD O' O A}
           (B : O_reflector O' A -&gt; Type) `{forall a, In O (B a)}
  : IsEquiv (fun (h : forall oa, B oa) =&gt; h oD to O' A).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 73
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 74
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  apply isequiv_ooextendable, extendable_to_OO; assumption.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 75
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Defined.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 76
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>


(** ** The strong order *)

(** Note the reversal of the order: [O1 &lt;&lt; O2] means that [O2] has dependent eliminators into [O1]. *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 81
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>Class O_strong_leq (O1 O2 : ReflectiveSubuniverse)
  := reflectsD_strong_leq :: forall A, ReflectsD O2 O1 A.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 82
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

Infix "&lt;&lt;" := O_strong_leq : subuniverse_scope.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 84
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Open Scope subuniverse_scope.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 85
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

(** The strong order implies the weak order. *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 87
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>Instance O_leq_strong_leq {O1 O2 : ReflectiveSubuniverse} `{O1 &lt;&lt; O2}
  : O1 &lt;= O2.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 88
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 89
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  intros A A_inO1.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 90
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  srapply inO_to_O_retract.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 91
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 92
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> exact (OO_ind O1 (fun _:O2 A =&gt; A) idmap).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 92
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 93
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> intros a.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 93
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> srapply OO_ind_beta.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 93
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Defined.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 94
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

(** The strong order is not obviously transitive, but it composes with the weak order on one side at least. *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 96
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>Definition O_strong_leq_trans_l (O1 O2 O3 : ReflectiveSubuniverse)
           `{O1 &lt;= O2} `{O2 &lt;&lt; O3}
  : O1 &lt;&lt; O3.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 98
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 99
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  intros A; constructor; intros B B_inO.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 100
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  apply (extendable_to_OO (O := O2)).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 101
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  intros x.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 102
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  srapply inO_leq; exact B_inO.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 103
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Defined.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 104
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>


(** ** Modalities  *)

(** A modality is a reflective subuniverse with a dependent universal property with respect to itself. *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 109
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>Notation IsModality O := (O &lt;&lt; O).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 109
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

(** However, it's not clear what the best bundled definition of modality is.  The obvious one [{ O : ReflectiveSubuniverse &amp; IsModality O}] has the advantage that bundling a reflective subuniverse into a modality and then unbundling it is definitionally the identity; but it is redundant, since the dependent universal property implies the non-dependent one, and in practice most modalities are constructed directly with a dependent eliminator.  Thus, for now at least, we take the following definition, which in RSS is called a "uniquely eliminating modality".  *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 111
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>Record Modality@{i} := Build_Modality'
{
  modality_subuniv : Subuniverse@{i} ;
  modality_prereflects : forall (T : Type@{i}),
      PreReflects modality_subuniv T ;
  modality_reflectsD :: forall (T : Type@{i}),
      ReflectsD modality_subuniv modality_subuniv T ;
}.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 118
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

(** We don't declare [modality_subuniv] as a coercion or [modality_prereflects] as a global instance, because we want them only to be found by way of the following "unbundling" coercion to reflective subuniverses. *)

</pre>
</div>
<div class="code" title="File: Modality.v
Line: 121
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>Definition modality_to_reflective_subuniverse (O : Modality@{i})
  : ReflectiveSubuniverse@{i}.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 122
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 123
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  refine (Build_ReflectiveSubuniverse
            (modality_subuniv O) (modality_prereflects O) _).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 125
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  intros T; constructor.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 126
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  intros Q Q_inO.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 127
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  srapply extendable_to_OO.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 128
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Defined.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 129
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

Coercion modality_to_reflective_subuniverse : Modality &gt;-&gt; ReflectiveSubuniverse.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 131
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

(** Unfortunately, sometimes [modality_subuniv] pops up anyway.  The following hint helps typeclass inference look through it. *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 133
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>#[export]
Hint Extern 0 (In (modality_subuniv _) _) =&gt; progress change modality_subuniv with (rsu_subuniv o modality_to_reflective_subuniverse) in * : typeclass_instances.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 134
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

(** Modalities are precisely the reflective subuniverses that are [&lt;&lt;] themselves.  *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 136
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>Instance ismodality_modality (O : Modality) : IsModality O.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 136
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 137
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  intros A; exact _.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 138
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Defined.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 139
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

Definition modality_ismodality (O : ReflectiveSubuniverse) `{IsModality O} : Modality.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 141
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 142
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  rapply Build_Modality'.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 143
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Defined.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 144
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

(** When combined with [isequiv_oD_to_O], this yields Theorem 7.7.7 in the book. *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 146
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>Definition isequiv_oD_to_O_modality
           `{Funext} (O : Modality) {A : Type}
           (B : O A -&gt; Type) `{forall a, In O (B a)}
  : IsEquiv (fun (h : forall oa, B oa) =&gt; h oD to O A).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 149
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 150
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>
  srapply (isequiv_oD_to_O O O).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 151
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Defined.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 152
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

(** Of course, modalities have dependent eliminators. *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 154
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>Definition O_ind {O : Subuniverse} {A : Type} `{ReflectsD O O A}
  := @OO_ind O O A _ _.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 155
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Arguments O_ind {O A _ _} B {B_inO} f oa.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 156
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Definition O_ind_beta {O : Subuniverse} {A : Type} `{ReflectsD O O A}
  := @OO_ind_beta O O A _ _.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 158
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Arguments O_ind_beta {O A _ _} B {B_inO} f a.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 159
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

(** Conversely, as remarked above, we can build a modality from a dependent eliminator as long as we assume the modal types are closed under paths.  This is probably the most common way to define a modality, and one might argue that this would be a better definition of the bundled type [Modality].  For now we simply respect that by dignifying it with the unprimed constructor name [Build_Modality]. *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 161
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>Definition Build_Modality
           (In' : Type -&gt; Type)
           (hprop_inO' : Funext -&gt; forall T : Type, IsHProp (In' T))
           (inO_equiv_inO' : forall T U : Type,
               In' T -&gt; forall f : T -&gt; U, IsEquiv f -&gt; In' U)
           (O_reflector' : Type -&gt; Type)
           (O_inO' : forall T, In' (O_reflector' T))
           (to' : forall T, T -&gt; O_reflector' T)
           (O_ind' : forall (A : Type) (B : O_reflector' A -&gt; Type)
                            (B_inO : forall oa, In' (B oa))
                            (f : forall a, B (to' A a))
                            (z : O_reflector' A),
               B z)
           (O_ind_beta' : forall (A : Type) (B : O_reflector' A -&gt; Type)
                                 (B_inO : forall oa, In' (B oa))
                                 (f : forall a, B (to' A a)) (a : A),
               O_ind' A B B_inO f (to' A a) = f a)
           (inO_paths' : forall (A : Type) (A_inO : In' A) (z z' : A),
               In' (z = z'))
  : Modality.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 180
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 181
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  pose (O := Build_Subuniverse In' hprop_inO' inO_equiv_inO').</pre>
</div>
<div class="code" title="File: Modality.v
Line: 182
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  simple refine (Build_Modality' O _ _); intros T.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 183
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 184
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> exact (Build_PreReflects O T (O_reflector' T) (O_inO' T) (to' T)).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 184
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 185
Time: 0.002s">
<div class="time" style="width: 5.2631578947368%"></div>
<pre> srapply reflectsD_from_OO_ind.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 185
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> 
    +</pre>
</div>
<div class="code" title="File: Modality.v
Line: 186
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> rapply O_ind'.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 186
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    +</pre>
</div>
<div class="code" title="File: Modality.v
Line: 187
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> rapply O_ind_beta'.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 187
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    +</pre>
</div>
<div class="code" title="File: Modality.v
Line: 188
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> exact inO_paths'.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 188
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Defined.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 189
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

(** A tactic that extends [strip_reflections] to modalities. It handles non-dependent elimination for reflective subuniverses and dependent elimination for modalities. [strip_truncations] does the same for truncations, but introduces fewer universe variables, so tends to work better when removing truncations. *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 191
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>Ltac strip_modalities :=
  (** Search for hypotheses of type [O X] for some [O] such that the goal is [O]-local. *)
  progress repeat
    match goal with
    | [ T : _ |- _ ]
      =&gt; revert_opaque T;
        (** Handle the non-dependent and dependent cases.  The last case requires that [O] be a modality. *)
        refine (@O_rec _ _ _ _ _ _ _) || refine (@O_indpaths _ _ _ _ _ _ _ _ _) || refine (@O_ind _ _ _ _ _ _ _);
        (** Ensure that we didn't generate more than one subgoal, i.e. that the goal was appropriately local. *)
        [];
        intro T
  end.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 202
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

(** ** Dependent sums *)

(** A dependent elimination of a reflective subuniverse [O'] into [O] implies that the sum of a family of [O]-modal types over an [O']-modal type is [O']-modal.  More specifically, for a particular such sum it suffices for the [O']-reflection of that sum to dependently eliminate into [O]. *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 206
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>Instance inO_sigma_reflectsD
       {O' : ReflectiveSubuniverse} {O : Subuniverse}
       {A : Type} (B : A -&gt; Type) `{!ReflectsD O' O (sig B)}
       `{In O' A} `{forall a, In O (B a)}
  : In O' {x:A &amp; B x}.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 210
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 211
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  pose (h := fun x =&gt; @O_rec O' ({x:A &amp; B x}) A _ _ _ pr1 x).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 212
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  assert (p := (fun z =&gt; O_rec_beta pr1 z) : h o (to O' _) == pr1).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 213
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  pose (g := fun z =&gt; (transport B ((p z)^) z.2)).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 214
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  simpl in *.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 215
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>
  pose (f := OO_ind O (fun x:O' (sig B) =&gt; B (h x)) g).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 216
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>
  pose (q := OO_ind_beta (fun x:O' (sig B) =&gt; B (h x)) g).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 217
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  apply inO_to_O_retract with (mu := fun w =&gt; (h w; f w)).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 218
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  intros [x1 x2].</pre>
</div>
<div class="code" title="File: Modality.v
Line: 219
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  simple refine (path_sigma B _ _ _ _); simpl.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 220
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 221
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> apply p.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 221
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 222
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> refine (ap _ (q (x1;x2)) @ _).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 222
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    unfold g; simpl.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 223
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> exact (transport_pV B _ _).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 223
Time: 0.003s">
<div class="time" style="width: 7.8947368421053%"></div>
<pre>
Defined.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 224
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

(** Specialized to a modality, this yields the implication (ii) =&gt; (i) from Theorem 7.7.4 of the book, and also Corollary 7.7.8, part 2. *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 226
Time: 0.004s">
<div class="time" style="width: 10.526315789474%"></div>
<pre>Instance inO_sigma (O : Modality)
           {A:Type} (B : A -&gt; Type) `{In O A} `{forall a, In O (B a)}
  : In O {x:A &amp; B x}
  := _.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 229
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

(** This implies that the composite of modal maps is modal. *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 231
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>Instance mapinO_compose {O : Modality} {A B C : Type} (f : A -&gt; B) (g : B -&gt; C)
       `{MapIn O _ _ f} `{MapIn O _ _ g}
  : MapIn O (g o f).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 233
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 234
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  intros c.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 235
Time: 0.012s">
<div class="time" style="width: 31.578947368421%"></div>
<pre>
  exact (inO_equiv_inO' _ (hfiber_compose f g c)^-1).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 236
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>
Defined.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 237
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

(** It also implies Corollary 7.3.10 from the book, generalized to modalities.  (Theorem 7.3.9 is true for any reflective subuniverse; we called it [equiv_O_sigma_O].) *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 239
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>Corollary equiv_sigma_inO_O {O : Modality} {A : Type} `{In O A} (P : A -&gt; Type)
  : {x:A &amp; O (P x)} &lt;~&gt; O {x:A &amp; P x}.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 240
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 241
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  transitivity (O {x:A &amp; O (P x)}).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 242
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 243
Time: 0.003s">
<div class="time" style="width: 7.8947368421053%"></div>
<pre> rapply equiv_to_O.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 243
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 244
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> apply equiv_O_sigma_O.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 244
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Defined.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 245
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

(** Conversely, if the sum of a particular family of [O]-modal types over an [O']-reflection is in [O'], then that family admits a dependent eliminator. *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 247
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>Definition extension_from_inO_sigma
           {O' : Subuniverse} (O : Subuniverse)
           {A:Type} `{Reflects O' A} (B: O_reflector O' A -&gt; Type)
           {inO_sigma : In O' {z:O_reflector O' A &amp; B z}}
           (g : forall x, B (to O' A x))
  : ExtensionAlong (to O' A) B g.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 252
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 253
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  set (Z := sig B) in *.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 254
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  pose (g' := (fun a:A =&gt; (to O' A a ; g a)) : A -&gt; Z).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 255
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  pose (f' := O_rec (O := O') g').</pre>
</div>
<div class="code" title="File: Modality.v
Line: 256
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  pose (eqf := (O_rec_beta g')  : f' o to O' A == g').</pre>
</div>
<div class="code" title="File: Modality.v
Line: 257
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>
  pose (eqid := O_indpaths (pr1 o f') idmap (fun x =&gt; ap@{k i} pr1 (eqf x))).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 258
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  exists (fun z =&gt; transport B (eqid z) ((f' z).2)).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 259
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  intros a.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 260
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> unfold eqid.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 260
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  refine (_ @ pr2_path (O_rec_beta g' a)).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 261
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>
  refine (ap (fun p =&gt; transport B p (O_rec g' (to O' A a)).2) _).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 262
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>
  srapply O_indpaths_beta.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 263
Time: 0.002s">
<div class="time" style="width: 5.2631578947368%"></div>
<pre>
Defined.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 264
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

(** And even a full equivalence of spaces of sections.  This is stated in CORS Proposition 2.8 (but our version avoids funext by using [ooExtendableAlong], as usual).  *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 266
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>Definition ooextendable_from_inO_sigma
           {O' : ReflectiveSubuniverse} (O : Subuniverse)
           {A : Type} (B: O_reflector O' A -&gt; Type)
           {inO_sigma : In O' {z:O_reflector O' A &amp; B z}}
  : ooExtendableAlong (to O' A) B.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 270
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 271
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  intros n; generalize dependent A.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 272
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  induction n as [|n IHn]; intros; [ exact tt | cbn ].</pre>
</div>
<div class="code" title="File: Modality.v
Line: 273
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  refine (extension_from_inO_sigma O B , _).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 274
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  intros h k; napply IHn.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 275
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  set (Z := sig B) in *.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 276
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  pose (W := sig (fun a =&gt; B a * B a)).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 277
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>
  nrefine (inO_equiv_inO' (Pullback (A := W) (fun a:O_reflector O' A =&gt; (a;(h a,k a)))
                                   (fun z:Z =&gt; (z.1;(z.2,z.2)))) _).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 279
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  {</pre>
</div>
<div class="code" title="File: Modality.v
Line: 280
Time: 0.007s">
<div class="time" style="width: 18.421052631579%"></div>
<pre> refine (inO_pullback O' _ _).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 280
Time: 0.009s">
<div class="time" style="width: 23.684210526316%"></div>
<pre>
    exact (inO_equiv_inO' _ (equiv_sigprod_pullback B B)^-1).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 281
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> }</pre>
</div>
<div class="code" title="File: Modality.v
Line: 281
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  unfold Pullback.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 282
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  (** The rest is just extracting paths from sigma- and product types and contracting a couple of based path spaces. *)
 </pre>
</div>
<div class="code" title="File: Modality.v
Line: 284
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>apply equiv_functor_sigma_id; intros z; cbn.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 284
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre> 
  refine (_ oE equiv_functor_sigma_id _).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 285
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  2:intros; symmetry; apply equiv_path_sigma.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 286
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>
  refine (_ oE equiv_functor_sigma_id (fun z =&gt; equiv_functor_sigma_id (fun p =&gt; _))).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 287
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  2:symmetry; apply equiv_path_prod.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 288
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  cbn.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 289
Time: 0.022s">
<div class="time" style="width: 57.894736842105%"></div>
<pre> make_equiv_contr_basedpaths.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 289
Time: 0.029s">
<div class="time" style="width: 76.315789473684%"></div>
<pre>
Defined.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 290
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

(** Thus, if this holds for all sigma-types, we get the dependent universal property.  Making this an [Instance] causes typeclass search to spin.  Note the slightly different hypotheses, which mean that we can't just use the previous result: here we need only assume that the [O']-reflection of [A] exists rather than that [O'] is fully reflective, at the cost of assuming that [O] is fully reflective (although actually, closed under path-spaces would suffice). *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 292
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>Definition reflectsD_from_inO_sigma
           {O' : Subuniverse} (O : ReflectiveSubuniverse)
           {A : Type} `{Reflects O' A}
           (inO_sigma : forall (B: O_reflector O' A -&gt; Type),
               (forall oa, In O (B oa)) -&gt; In O' {z:O_reflector O' A &amp; B z})
  : ReflectsD O' O A.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 297
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 298
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  constructor; intros B B_inO.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 299
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  intros n; generalize dependent A.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 300
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  induction n as [|n IHn]; intros; [ exact tt | cbn ].</pre>
</div>
<div class="code" title="File: Modality.v
Line: 301
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  refine (extension_from_inO_sigma O B , _).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 302
Time: 0.003s">
<div class="time" style="width: 7.8947368421053%"></div>
<pre>
  intros h k; rapply IHn.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 303
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Defined.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 304
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

(** In particular, we get the converse implication (i) =&gt; (ii) from Theorem 7.7.4 of the book: a reflective subuniverse closed under sigmas is a modality. *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 306
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>Definition modality_from_inO_sigma (O : ReflectiveSubuniverse)
           (H : forall (A:Type) (B:A -&gt; Type)
                       {A_inO : In O A} `{forall a, In O (B a)},
               (In O {x:A &amp; B x}))
  : Modality.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 310
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 311
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  refine (Build_Modality' O _ _).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 312
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>
  intros; srapply reflectsD_from_inO_sigma.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 313
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Defined.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 314
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>


(** ** Connectedness of the units *)

(** Dependent reflection can also be characterized by connectedness of the unit maps. *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 319
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>Instance conn_map_to_O_reflectsD {O' : Subuniverse} (O : ReflectiveSubuniverse)
       {A : Type} `{ReflectsD O' O A}
  : IsConnMap O (to O' A).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 321
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 322
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>       
  apply conn_map_from_extension_elim.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 323
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  intros P P_inO f.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 324
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  exact (fst (extendable_to_OO (O := O) P 1%nat) f).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 325
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Defined.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 326
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

Definition reflectsD_from_conn_map_to_O {O' : Subuniverse} (O : ReflectiveSubuniverse)
           {A : Type} `{PreReflects O' A} `{IsConnMap O _ _ (to O' A)}
  : ReflectsD O' O A.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 330
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 331
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  constructor; rapply ooextendable_conn_map_inO.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 332
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Defined.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 333
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

(** In particular, if [O1 &lt;&lt; O2] then every [O2]-unit is [O1]-connected. *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 335
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>Instance conn_map_to_O_strong_leq
       {O1 O2 : ReflectiveSubuniverse} `{O1 &lt;&lt; O2} (A : Type)
  : IsConnMap O1 (to O2 A)
  := _.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 338
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

(** Thus, if [O] is a modality, then every [O]-unit is [O]-connected.  This is Corollary 7.5.8 in the book. *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 340
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>Instance conn_map_to_O {O : Modality} (A : Type)
  : IsConnMap O (to O A)
  := _.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 342
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

(** When [O1 &lt;&lt; O2], [O_functor O2] preserves [O1]-connected maps. *)</pre>
</div>
<div class="code" title="File: Modality.v
Line: 344
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>Proposition conn_map_O_functor_strong_leq {O1 O2 : ReflectiveSubuniverse} (leq : O1 &lt;&lt; O2)
  {X Y : Type} (f : X -&gt; Y) `{IsConnMap O1 _ _ f}
  : IsConnMap O1 (O_functor O2 f).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 346
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 347
Time: 0.011s">
<div class="time" style="width: 28.947368421053%"></div>
<pre>
  rapply (cancelR_conn_map _ (to O2 _)).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 348
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>
  napply conn_map_homotopic.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 349
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  1: symmetry; apply to_O_natural.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 350
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>
  rapply conn_map_compose.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 351
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
Defined.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 352
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>


(** ** Easy modalities *)

(** The book uses yet a different definition of modality, which requires an induction principle only into families of the form [fun oa =&gt; O (B oa)], and similarly only that path-spaces of types [O A] are "modal" in the sense that the unit is an equivalence.  As shown in section 1 of RSS, this is equivalent, roughly since every modal type [A] (in this sense) is equivalent to [O A].

Our definitions are more convenient in formalized applications because in some examples (such as [Trunc] and closed modalities), there is a naturally occurring [O_ind] into all modal types that is not judgmentally equal to the one that can be constructed by passing through [O] and back again.  Thus, when we apply general theorems about modalities to a particular modality such as [Trunc], the proofs will reduce definitionally to "the way we would have proved them directly" if we didn't know about general modalities.

On the other hand, in other examples (such as [~~] and open modalities) it is easier to construct the latter weaker induction principle.  Thus, we now show how to get from that to our definition of modality. *)

</pre>
</div>
<div class="code" title="File: Modality.v
Line: 362
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>Section EasyModalities.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 362
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

  Universe i.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 364
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>
  Context (O_reflector : Type@{i} -&gt; Type@{i})
          (to : forall (T : Type@{i}), T -&gt; O_reflector T)
          (O_indO
           : forall (A : Type@{i})
                    (B : O_reflector A -&gt; Type@{i})
                    (f : forall a, O_reflector (B (to A a)))
                    (z : O_reflector A),
              O_reflector (B z))
          (O_indO_beta
           : forall (A : Type@{i})
                    (B : O_reflector A -&gt; Type@{i})
                    (f : forall a, O_reflector (B (to A a))) (a : A),
              O_indO A B f (to A a) = f a)
          (inO_pathsO
           : forall (A : Type@{i}) (z z' : O_reflector A),
              IsEquiv (to (z = z'))).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 380
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

  Local Definition In_easy : Type@{i} -&gt; Type@{i}
    := fun A =&gt; IsEquiv (to A).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 383
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

  Local Definition O_ind_easy
             (A : Type) (B : O_reflector A -&gt; Type)
             (B_inO : forall oa, In_easy (B oa))
    : (forall a, B (to A a)) -&gt; forall oa, B oa.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 388
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 389
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    simpl; intros f oa.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 390
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    pose (H := B_inO oa); unfold In_easy in H.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 391
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    apply ((to (B oa))^-1).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 392
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    apply O_indO.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 393
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    intros a; apply to, f.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 394
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  Defined.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 395
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

  Local Definition O_ind_easy_beta
             (A : Type) (B : O_reflector A -&gt; Type)
             (B_inO : forall oa, In_easy (B oa))
             (f : forall a : A, B (to A a)) (a:A)
  : O_ind_easy A B B_inO f (to A a) = f a.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 401
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 402
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    unfold O_ind_easy.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 403
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    apply moveR_equiv_V.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 404
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    apply @O_indO_beta with (f := fun x =&gt; to _ (f x)).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 405
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  Qed.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 406
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

  Local Definition O_inO_easy (A : Type) : In_easy (O_reflector A).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 408
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 409
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    refine (isequiv_adjointify (to (O_reflector A))
             (O_indO (O_reflector A) (fun _ =&gt; A) idmap) _ _).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 411
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 412
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> intros x; pattern x; apply O_ind_easy.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 412
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
      +</pre>
</div>
<div class="code" title="File: Modality.v
Line: 413
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> intros oa; apply inO_pathsO.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 413
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
      +</pre>
</div>
<div class="code" title="File: Modality.v
Line: 414
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> intros a; apply ap.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 414
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
        exact (O_indO_beta (O_reflector A) (fun _ =&gt; A) idmap a).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 415
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 416
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> intros a.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 416
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
      exact (O_indO_beta (O_reflector A) (fun _ =&gt; A) idmap a).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 417
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  Defined.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 418
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

  (** It seems to be surprisingly hard to show repleteness (without univalence).  We basically have to manually develop enough functoriality of [O] and naturality of [to O]. *)
 </pre>
</div>
<div class="code" title="File: Modality.v
Line: 421
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>Local Definition inO_equiv_inO_easy (A B : Type)
        (A_inO : In_easy A) (f : A -&gt; B) (feq : IsEquiv f)
    : In_easy B.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 423
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 424
Time: 0.002s">
<div class="time" style="width: 5.2631578947368%"></div>
<pre>
    simple refine (isequiv_commsq (to A) (to B) f
             (O_ind_easy A (fun _ =&gt; O_reflector B) _ (fun a =&gt; to B (f a))) _).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 426
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 427
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> intros; apply O_inO_easy.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 427
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 428
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> intros a; exact (O_ind_easy_beta A (fun _ =&gt; O_reflector B) _ _ a).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 428
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 429
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> exact A_inO.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 429
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 430
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> simple refine (isequiv_adjointify _
               (O_ind_easy B (fun _ =&gt; O_reflector A) _ (fun b =&gt; to A (f^-1 b))) _ _);
        intros x.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 432
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
      +</pre>
</div>
<div class="code" title="File: Modality.v
Line: 433
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> apply O_inO_easy.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 433
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
      +</pre>
</div>
<div class="code" title="File: Modality.v
Line: 434
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> pattern x; refine (O_ind_easy B _ _ _ x); intros.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 434
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
        *</pre>
</div>
<div class="code" title="File: Modality.v
Line: 435
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> apply inO_pathsO.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 435
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
        *</pre>
</div>
<div class="code" title="File: Modality.v
Line: 436
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre> simpl; abstract (repeat rewrite O_ind_easy_beta; apply ap, eisretr).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 436
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
      +</pre>
</div>
<div class="code" title="File: Modality.v
Line: 437
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> pattern x; refine (O_ind_easy A _ _ _ x); intros.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 437
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
        *</pre>
</div>
<div class="code" title="File: Modality.v
Line: 438
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> apply inO_pathsO.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 438
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
        *</pre>
</div>
<div class="code" title="File: Modality.v
Line: 439
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre> simpl; abstract (repeat rewrite O_ind_easy_beta; apply ap, eissect).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 439
Time: 0.013s">
<div class="time" style="width: 34.210526315789%"></div>
<pre>
  Defined.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 440
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

  Local Definition inO_paths_easy (A : Type) (A_inO : In_easy A) (a a' : A)
    : In_easy (a = a').</pre>
</div>
<div class="code" title="File: Modality.v
Line: 443
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 444
Time: 0.004s">
<div class="time" style="width: 10.526315789474%"></div>
<pre>
    simple refine (inO_equiv_inO_easy (to A a = to A a') _ _
                                      (@ap _ _ (to A) a a')^-1 _).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 446
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 447
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> apply inO_pathsO.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 447
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 448
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> exact (@isequiv_ap _ _ _ A_inO _ _).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 448
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 449
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> apply isequiv_inverse.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 449
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  Defined.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 450
Time: 0.002s">
<div class="time" style="width: 5.2631578947368%"></div>
<pre>

  Definition easy_modality : Modality
    := Build_Modality In_easy _ inO_equiv_inO_easy O_reflector O_inO_easy to O_ind_easy O_ind_easy_beta inO_paths_easy.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 453
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>

End EasyModalities.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 455
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>


(** ** The modal factorization system *)

</pre>
</div>
<div class="code" title="File: Modality.v
Line: 459
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>Section ModalFact.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 459
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  Context `{fs : Funext} (O : Modality).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 460
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

  (** Lemma 7.6.4 *)
 </pre>
</div>
<div class="code" title="File: Modality.v
Line: 463
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>Definition image {A B : Type} (f : A -&gt; B)
  : Factorization (@IsConnMap O) (@MapIn O) f.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 464
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 465
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    pose mapinO_pr1.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 466
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> (** Slightly speeds up next line. *)
   </pre>
</div>
<div class="code" title="File: Modality.v
Line: 467
Time: 0.002s">
<div class="time" style="width: 5.2631578947368%"></div>
<pre>refine (Build_Factorization {b : B &amp; O (hfiber f b)}
                                (fun a =&gt; (f a ; to O _ (a;1)))
                                pr1
                                (fun a =&gt; 1)
                                _ _).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 471
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    pose conn_map_functor_sigma.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 472
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> (** Slightly speeds up next line. *)
   </pre>
</div>
<div class="code" title="File: Modality.v
Line: 473
Time: 0.026s">
<div class="time" style="width: 68.421052631579%"></div>
<pre>exact (conn_map_compose O
              (equiv_fibration_replacement f)
              (functor_sigma idmap (fun b =&gt; to O (hfiber f b)))).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 475
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>
  Defined.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 476
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

  #[export] Instance conn_map_factor1_image {A B : Type} (f : A -&gt; B)
  : IsConnMap O (factor1 (image f))
    := inclass1 (image f).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 480
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

  #[export] Instance inO_map_factor2_image {A B : Type} (f : A -&gt; B)
  : MapIn O (factor2 (image f))
    := inclass2 (image f).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 484
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

  (** This is the composite of the three displayed equivalences at the beginning of the proof of Lemma 7.6.5.  Note that it involves only a single factorization of [f]. *)
 </pre>
</div>
<div class="code" title="File: Modality.v
Line: 487
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>Lemma O_hfiber_O_fact {A B : Type} {f : A -&gt; B}
        (fact : Factorization (@IsConnMap O) (@MapIn O) f) (b : B)
  : O (hfiber (factor2 fact o factor1 fact) b)
      &lt;~&gt; hfiber (factor2 fact) b.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 490
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 491
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    refine (_ oE
             (equiv_O_functor O
               (hfiber_compose (factor1 fact) (factor2 fact) b))).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 494
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    nrefine (equiv_sigma_contr (fun w =&gt; O (hfiber (factor1 fact) w.1)) oE _).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 495
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 496
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> intros w; exact (inclass1 fact w.1).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 496
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 497
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> nrefine ((equiv_sigma_inO_O (fun w =&gt; hfiber (factor1 fact) w.1))^-1)%equiv.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 497
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
      exact (inclass2 fact b).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 498
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  Defined.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 499
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

  (** This is the corresponding first three of the displayed "mapsto"s in proof of Lemma 7.6.5, and also the last three in reverse order, generalized to an arbitrary path [p].  Note that it is much harder to prove than in the book, because we are working in the extra generality of a modality where [O_ind_beta] is only propositional. *)
 </pre>
</div>
<div class="code" title="File: Modality.v
Line: 502
Time: 0.006s">
<div class="time" style="width: 15.789473684211%"></div>
<pre>Lemma O_hfiber_O_fact_inverse_beta {A B : Type} {f : A -&gt; B}
        (fact : Factorization (@IsConnMap O) (@MapIn O) f)
        (a : A) (b : B) (p : factor2 fact (factor1 fact a) = b)
  : (O_hfiber_O_fact fact b)^-1
      (factor1 fact a ; p) = to O _ (a ; p).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 506
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 507
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    set (g := factor1 fact); set (h := factor2 fact).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 508
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    apply moveR_equiv_V.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 509
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    unfold O_hfiber_O_fact.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 510
Time: 0.015s">
<div class="time" style="width: 39.473684210526%"></div>
<pre>
    ev_equiv.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 511
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>
    apply moveL_equiv_M.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 512
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>
    transitivity (exist (fun (w : hfiber h b) =&gt; O (hfiber g w.1))
                         (g a; p) (to O (hfiber g (g a)) (a ; 1))).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 514
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 515
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> apply moveR_equiv_V; reflexivity.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 515
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 516
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> apply moveL_equiv_V.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 516
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>
      transitivity (to O _ (exist (fun (w : hfiber h b) =&gt; (hfiber g w.1))
                         (g a; p) (a ; 1))).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 518
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
      +</pre>
</div>
<div class="code" title="File: Modality.v
Line: 519
Time: 0.003s">
<div class="time" style="width: 7.8947368421053%"></div>
<pre> cbn; repeat rewrite O_rec_beta; reflexivity.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 519
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
      +</pre>
</div>
<div class="code" title="File: Modality.v
Line: 520
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre> destruct p; symmetry; apply to_O_natural.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 520
Time: 0.009s">
<div class="time" style="width: 23.684210526316%"></div>
<pre>
  Qed.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 521
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

  Section TwoFactorizations.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 523
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    Context {A B : Type} (f : A -&gt; B)
            (fact fact' : Factorization (@IsConnMap O) (@MapIn O) f).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 525
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

    Let H := fun x =&gt; fact_factors fact x @ (fact_factors fact' x)^.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 527
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

    (** Lemma 7.6.5, part 1. *)
   </pre>
</div>
<div class="code" title="File: Modality.v
Line: 530
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>Definition equiv_O_factor_hfibers (b:B)
    : hfiber (factor2 fact) b &lt;~&gt; hfiber (factor2 fact') b.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 531
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 532
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
      refine (O_hfiber_O_fact fact' b oE _).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 533
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
      refine (_ oE (O_hfiber_O_fact fact b)^-1).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 534
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
      apply equiv_O_functor.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 535
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
      apply equiv_hfiber_homotopic.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 536
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
      exact H.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 537
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    Defined.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 538
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

    (** Lemma 7.6.5, part 2. *)
   </pre>
</div>
<div class="code" title="File: Modality.v
Line: 541
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>Definition equiv_O_factor_hfibers_beta (a : A)
    : equiv_O_factor_hfibers (factor2 fact (factor1 fact a))
                             (factor1 fact a ; 1)
      = (factor1 fact' a ; (H a)^).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 544
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 545
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
      unfold equiv_O_factor_hfibers.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 546
Time: 0.008s">
<div class="time" style="width: 21.052631578947%"></div>
<pre>
      ev_equiv.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 547
Time: 0.002s">
<div class="time" style="width: 5.2631578947368%"></div>
<pre>
      apply moveR_equiv_M.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 548
Time: 0.002s">
<div class="time" style="width: 5.2631578947368%"></div>
<pre>
      do 2 rewrite O_hfiber_O_fact_inverse_beta.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 549
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
      unfold equiv_fun, equiv_O_functor.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 550
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>
      transitivity (to O _
                       (equiv_hfiber_homotopic
                          (factor2 fact o factor1 fact)
                          (factor2 fact' o factor1 fact') H
                          (factor2 fact (factor1 fact a)) (a;1))).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 555
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
      -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 556
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> exact (to_O_natural O _ _).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 556
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
      -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 557
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> apply ap.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 557
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
        simpl.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 558
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
        apply ap; auto with path_hints.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 559
Time: 0.003s">
<div class="time" style="width: 7.8947368421053%"></div>
<pre>
    Qed.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 560
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

  End TwoFactorizations.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 562
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

  (** Theorem 7.6.6.  Recall that a lot of hard work was done in [Factorization.path_factorization]. *)
 </pre>
</div>
<div class="code" title="File: Modality.v
Line: 565
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>Definition O_factsys : FactorizationSystem.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 565
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
  Proof.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 566
Time: 0.011s">
<div class="time" style="width: 28.947368421053%"></div>
<pre>
    refine (Build_FactorizationSystem
              (@IsConnMap O) _ _ _
              (@MapIn O) _ _ _
              (@image) _).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 570
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    intros A B f fact fact'.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 571
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    simple refine (Build_PathFactorization fact fact' _ _ _ _).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 572
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 573
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> refine (_ oE equiv_fibration_replacement (factor2 fact)).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 573
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
      refine ((equiv_fibration_replacement (factor2 fact'))^-1 oE _).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 574
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
      apply equiv_functor_sigma_id; intros b; simpl.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 575
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
      apply equiv_O_factor_hfibers.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 576
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 577
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> intros a; exact (pr1_path (equiv_O_factor_hfibers_beta f fact fact' a)).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 577
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 578
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> intros x.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 578
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
      exact ((equiv_O_factor_hfibers f fact fact' (factor2 fact x) (x ; 1)).2 ^).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 579
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
    -</pre>
</div>
<div class="code" title="File: Modality.v
Line: 580
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre> intros a.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 580
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
      apply moveR_pM.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 581
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>
      refine ((inv_V _)^ @ _ @ inv_V _); apply inverse2.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 582
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
      refine (_ @ pr2_path (equiv_O_factor_hfibers_beta f fact fact' a)).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 583
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>
      refine (_ @ (transport_paths_Fl _ _)^).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 584
Time: 0.001s">
<div class="time" style="width: 2.6315789473684%"></div>
<pre>
      exact (inv_pp _ _ @ (1 @@ inv_V _)).</pre>
</div>
<div class="code" title="File: Modality.v
Line: 585
Time: 0.016s">
<div class="time" style="width: 42.105263157895%"></div>
<pre>
  Defined.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 586
Time: 0.008s">
<div class="time" style="width: 21.052631578947%"></div>
<pre>

End ModalFact.</pre>
</div>
<div class="code" title="File: Modality.v
Line: 589
Time: 0s">
<div class="time" style="width: 0%"></div>
<pre>

</pre>
</div>
</body>
</html>

